---
title: Predicting Survival of Intensive Care Unit Patients with Support Vector Machines
authors: 
  - name: Josh Hollandsworth
  - name: Brad Lipson
  - name: Eric Miller
date: last-modified
format:
  html:
    code-fold: true
course: STA 6257 - Advanced Statistical Modeling
bibliography: ./references.bib # file contains bibtex for references
#always_allow_html: true # this allows to get PDF with HTML features
self-contained: true
execute: 
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
nocite: |
  @*
---

```{r, echo=FALSE}
library(easypackages)
libraries( c("tidyverse", 
    "ggthemes",
    "ggrepel",
    "dslabs", 
    "ggplot2",
    "dplyr",
    "data.table",
    "extrafont",
    "dataMaid",
    "gtsummary"
))

mimic_data <- fread("./MIMIC_ICU_DATA/mimic_icu_data.csv")
```


# Introduction

Every day sensors and systems are capturing a virtual flood of data points and feeding those values into powerful 
artificial intelligence and machine learning systems to derive classifications and predict a myriad of outcomes. 
These systems help us do a broad spectrum of things from fraud detection to interactions with smart home systems. 
Given the number of data points that are present in the medical field, it is of no surprise that machine learning is 
increasingly being leveraged to elevate patient care.

For as long as most of us remember, our interactions with physicians have included the gathering of data points to help them 
detect illness and track progression of disease. Common data points are age, weight, height, temperature, blood pressure,
list of any current symptoms and etc. Physicians then use their education and years of practice to provide diagnoses and 
help us live happy and healthy lives. But what if this was process could be supported with machine learning, 
and brought into a more critical care setting? 

We can. Thanks to machine learning we can use data from the countless sensors and measurements taken by medical staff in Intensive 
Care Units (ICU) to predict the survivability of patients under care. This data can then help teams organize around certain 
cases to help ensure the best allotment of resources and highest attention to the most dire of cases. A method we will use 
in this report is through the construction of Support Vector Machines or SVM's. 

SVM's are a machine learning methodology that uses supervised learning based on historic cases to help train models that can 
then be used on other cases. Models created by Support Vector Machines are used to create clusters of 2 distinct groups of 
data based on the creation of a maximally-marginal hyperplane.[@han2012]. A maximally-marginal hyperplane can be explained 
as a line that can be drawn between two clusters that separates their members with the greatest distance between members of 
each cluster that are their nearest. 

While we did not find many cases of using support vector machines for ICU patient survival, the use of Support Vector Machines 
in medicine is not a novel approach. In "Using Support Vector Machines for Diabetes Mellitus Classification from Electronic 
Medical Records" by Adeoye the author leveraged electronic medical records to help classify individuals with and without 
diabetes. Meanwhile, Zhou et al where able to use Support Vector Machines to predict the prognosis of severe, acute myocardial 
infarction with 92% accuracy from electronic medical records[@zhou2023]

While Support Vector Machines can be a great utility used to cluster and predict outcomes, their usage in Medicine is not without 
problems. One problem noted by Liu et al is that the sheer number of data points available can make it hard to find features (data 
points of importance) for use in model construction.[@liu2018] In fact Liu goes as far as describing the use of Principal Component Analysis 
to chose which features to include in model construction. Additionally, support vector machines work best when the data can be mapped 
linearly, however unlike other methodologies this is not a strict requirement. Should data not be easily linearly separable the use of a
kernel function or kernel trick allows data to be mapped from one space to another for optimal construction of the maximally marginal hyperplane [@han2012] [@mohan2020] 

# Methods

Data Source 

To build our model for predicting patient survivability, we are using data from the [Medical Information Mart for Intensive Care (MIMIC)](https://mimic.mit.edu). We are specifically targeting the MIMIC III data set. You can find more information about the MIMIC III dataset at [https://mimic.mit.edu/docs/iii/](https://mimic.mit.edu/docs/iii/)  The data set itself is rather large so we have pre-processed the data slightly in order to generate a file of comma separated values rather than consume directly from their highly normalized format.


# Analysis and Results

## Data and Vizualisation
```{r, dev = "png", dev.args=list(bg="transparent"), fig.align="left"}
library(gtsummary)

mimic_data_summary <- mimic_data %>% select(age, 
gender, 
hospital_expire_flag, 
heartrate_mean,
sysbp_mean,
resprate_mean,
tempc_mean,
wbc_mean,
platelet_min,
creatinine_max,
lactate_mean) %>%
mutate(
  gender = case_when(gender == "M" ~ "male",
                     gender == "F" ~ "female",
                     TRUE ~ gender),
  survived = case_when(hospital_expire_flag == 1 ~ "Died",
                     hospital_expire_flag == 0 ~ "Survived")
) %>%
  tbl_summary(
    label = list(age ~ "Patient Age", 
      gender ~ "Patient Sex", 
      survived ~ "Patient Survived",  
      heartrate_mean ~ "Heart Rate",
      sysbp_mean ~ "Systolic Blood Pressure",
      resprate_mean ~ "Respiration Rate",
      tempc_mean ~ "Body Temperature (c)",
      wbc_mean ~ "White Blood Cell Count",
      platelet_min ~"Platelet Count",
      creatinine_max ~"Creatinine Level",
      lactate_mean ~"Lactate Level"
      ),
     type = list(age ~ "continuous2", 
      gender ~ "categorical", 
      survived ~ "categorical",  
      heartrate_mean ~ "continuous2",
      sysbp_mean ~ "continuous2",
      resprate_mean ~ "continuous2",
      tempc_mean ~ "continuous2",
      wbc_mean ~ "continuous2",
      platelet_min ~"continuous2",
      creatinine_max ~"continuous2",
      lactate_mean ~"continuous2"
      ), 
      statistic = all_continuous() ~ c("{median} ({p25}, {p75})", "{min}, {max}"),
      include = c(
        "age", 
        "gender", 
        "heartrate_mean",
        "survived",
        "sysbp_mean",
        "resprate_mean",
        "tempc_mean",
        "wbc_mean",
        "platelet_min",
        "creatinine_max",
        "lactate_mean"
      ) 
  )



mimic_data_summary
```
### Patient Demographics

#### Patient Age
```{r}
ggplot(mimic_data, aes(x=age))+ 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```

#### Patient Sex
```{r, dev = "png", dev.args=list(bg="transparent"), fig.align="left"}
mimic_data <- mimic_data %>% mutate(
  gender = case_when(gender == "M" ~ "male",
                     gender == "F" ~ "female",
                     TRUE ~ gender)
)

patient_sex_viz <- mimic_data %>%
  group_by(gender) %>%
  summarise(N = n()) %>%
  mutate(
    gender = as.factor(gender),
    pos = cumsum(N) - N/2,
    label = paste(N,  " ", gender, "\npatients\n(", 100*round(N/sum(N), 2), "%)", sep="")
  )

ggplot(patient_sex_viz, aes(x = "", y = N, fill = gender)) +
  geom_bar(stat = "identity", width=1, color="white", position = "stack") +  
  coord_polar(theta = "y", direction = -1, clip = "off") +
  theme_economist(base_family="ITC Officina Sans") + 
  theme(
    legend.position="none",
    line=element_blank(),
    axis.title.x=element_blank(),
    axis.text.x=element_blank(), #remove x axis labels
    axis.ticks.x=element_blank(), #remove x axis ticks
    axis.title.y=element_blank(),
    axis.text.y=element_blank(),  #remove y axis labels
    axis.ticks.y=element_blank()  #remove y axis ticks
  ) + 
  geom_text(aes(y = pos, label = label), color = "white", size=6) +
  scale_fill_economist(labels=NULL)
```

#### Patient Survival
```{r, dev = "png", dev.args=list(bg="transparent"), fig.align="left"}
mimic_data <- mimic_data %>% mutate(
  survived = case_when(hospital_expire_flag == 1 ~ "Died",
                     hospital_expire_flag == 0 ~ "Survived")
)

ggplot(mimic_data, aes(x = survived, fill=survived)) +
  geom_bar(color="white") +  
  theme_economist(base_family="ITC Officina Sans") +
  scale_fill_economist(labels=NULL)
```

### Vital Signs

####	Heart rate
```{r}
ggplot(mimic_data, aes(x=heartrate_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```



####	Blood pressure: Median systolic blood pressure 134 mmHg (Q1–Q3: 116–154 mmHg); median diastolic blood pressure 78 mmHg (Q1–Q3: 66–90 mmHg)

```{r}
ggplot(mimic_data, aes(x=sysbp_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```


####	Respiratory rate
```{r}
ggplot(mimic_data, aes(x=resprate_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```
####	Temperature

```{r}
ggplot(mimic_data, aes(x=tempc_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```
####	Oxygen saturation: Median 96% (Q1–Q3: 93–99%)

```{r}
ggplot(mimic_data, aes(x=spo2_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```


### Laboratory Values
####	White blood cell count: Median 10.5 × 10^9 cells/L (Q1–Q3: 7.5–14.5 × 10^9 cells/L)
```{r}
ggplot(mimic_data, aes(x=wbc_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```
####	Neutrophil count: Median 7.5 × 10^9 cells/L (Q1–Q3: 5.4–11.2 × 10^9 cells/L)

*NOT FOUND IN DATA*

####	Lymphocyte count: Median 1.7 × 10^9 cells/L (Q1–Q3: 1.0–2.5 × 10^9 cells/L)
*NOT FOUND IN DATA*

####	Platelet count: Median 178 × 10^9 cells/L (Q1–Q3: 125–240 × 10^9 cells/L)
```{r}
ggplot(mimic_data, aes(x=platelet_min)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```
####	Creatinine: Median 1.0 mg/dL (Q1–Q3: 0.8–1.3 mg/dL)
```{r}
ggplot(mimic_data, aes(x=creatinine_max)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```
####	Bilirubin: Median 0.8 mg/dL (Q1–Q3: 0.5–1.2 mg/dL)
*NOT FOUND IN DATA*
####	Lactate dehydrogenase: Median 250 U/L (Q1–Q3: 190–330 U/L)
```{r}
ggplot(mimic_data, aes(x=lactate_mean)) + 
  geom_histogram( color="#e9ecef", fill="#188bc2", alpha=0.9, position = 'identity') +
  theme_economist(base_family="ITC Officina Sans")
```

## Statistical Modeling

# Conlusion

# References

